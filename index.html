<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no, viewport-fit=cover">
  <title>„Åæ„ÅÑ„Å∞„Åô„É©„É™„ÉºÔºàÊù±‰∫¨ÁâàÔºâ</title>
  
  <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>üõí</text></svg>">
  <link rel="manifest" href="manifest.json">
  <link rel="apple-touch-icon" href="icon.png">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="default">
  <meta name="theme-color" content="#F2F2F7">

  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <style>
    body { margin: 0; padding: 0; font-family: -apple-system, BlinkMacSystemFont, "SF Pro Text", "Helvetica Neue", sans-serif; display: flex; flex-direction: column; height: 100vh; height: 100dvh; background: #F2F2F7; color: #000; -webkit-font-smoothing: antialiased; }
    #map { height: 45%; width: 100%; z-index: 1; }
    #panel { height: 55%; background: #fff; display: flex; flex-direction: column; box-shadow: 0 -5px 20px rgba(0,0,0,0.1); z-index: 2; border-top-left-radius: 16px; border-top-right-radius: 16px; overflow: hidden; position: relative; }
    #header { padding: 16px 20px; background: rgba(255, 255, 255, 0.95); border-bottom: 0.5px solid #c6c6c8; text-align: center; position: sticky; top: 0; z-index: 10; backdrop-filter: blur(10px); }
    h2 { margin: 0; font-size: 17px; font-weight: 600; color: #000; letter-spacing: -0.5px; display: flex; align-items: center; justify-content: center; gap: 6px; }
    .area-badge { font-size: 10px; font-weight: normal; color: #666; background: #eee; padding: 2px 6px; border-radius: 4px; border: 1px solid #ddd; }
    #status-text { font-size: 13px; color: #8E8E93; margin-top: 4px; }
    .highlight { color: #007AFF; font-weight: 600; }

    /* „É°„Éã„É•„Éº„Éú„Çø„É≥ÔºàÂè≥‰∏ã„Å´ÈÖçÁΩÆÔºâ */
    #menu-btn {
      position: absolute; right: 20px; bottom: 30px; z-index: 20;
      background: #fff; border: 1px solid #c6c6c8; border-radius: 50%;
      width: 44px; height: 44px; display: flex; justify-content: center; align-items: center;
      font-size: 24px; box-shadow: 0 4px 15px rgba(0,0,0,0.15); cursor: pointer; transition: transform 0.1s;
    }
    #menu-btn:active { transform: scale(0.95); }

    /* „É¢„Éº„ÉÄ„É´„Ç¶„Ç£„É≥„Éâ„Ç¶ */
    #modal-overlay {
      display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%;
      background: rgba(0,0,0,0.5); z-index: 1000; justify-content: center; align-items: flex-end;
    }
    #modal-content {
      width: 100%; max-width: 600px; height: 85%; background: #F2F2F7;
      border-top-left-radius: 20px; border-top-right-radius: 20px;
      display: flex; flex-direction: column; overflow: hidden;
      transform: translateY(100%); transition: transform 0.3s cubic-bezier(0.2, 0.8, 0.2, 1);
    }
    #modal-overlay.show { display: flex; }
    #modal-overlay.show #modal-content { transform: translateY(0); }

    /* „É¢„Éº„ÉÄ„É´ÂÜÖ„Çπ„Çø„Ç§„É´Ôºàcontent.htmlÁî®Ôºâ */
    .modal-header { padding: 15px 20px; background: #fff; border-bottom: 1px solid #ddd; display: flex; justify-content: space-between; align-items: center; }
    .modal-header h3 { margin: 0; font-size: 18px; }
    .close-btn { background: none; border: none; font-size: 28px; color: #007AFF; cursor: pointer; padding: 0 10px; }
    .modal-body { flex: 1; overflow-y: auto; padding: 20px; -webkit-overflow-scrolling: touch; }
    
    section { background: #fff; border-radius: 12px; padding: 15px; margin-bottom: 20px; box-shadow: 0 1px 3px rgba(0,0,0,0.05); }
    h4 { margin: 0 0 10px 0; color: #333; font-size: 15px; }
    p { margin: 0 0 10px 0; font-size: 13px; line-height: 1.6; color: #333; }
    .small-text { font-size: 11px; color: #666; margin-bottom: 8px; }
    .note { font-size: 11px; color: #888; margin-top: 5px; }
    hr { border: none; border-top: 1px solid #e0e0e0; margin: 20px 0; }
    .version-info { text-align: center; color: #ccc; font-size: 10px; margin-top: 20px; }

    .setting-row { display: flex; justify-content: space-between; align-items: center; margin-bottom: 5px; }
    .setting-btn-area { margin-top: 15px; text-align: center; }
    .danger-btn { background: #fff; color: #FF3B30; border: 1px solid #FF3B30; padding: 8px 16px; border-radius: 8px; font-size: 13px; cursor: pointer; }
    
    .switch { position: relative; display: inline-block; width: 44px; height: 26px; }
    .switch input { opacity: 0; width: 0; height: 0; }
    .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #ccc; transition: .4s; border-radius: 26px; }
    .slider:before { position: absolute; content: ""; height: 22px; width: 22px; left: 2px; bottom: 2px; background-color: white; transition: .4s; border-radius: 50%; }
    input:checked + .slider { background-color: #34C759; }
    input:checked + .slider:before { transform: translateX(18px); }

    /* „É™„Çπ„Éà„Éª„Çπ„Çø„É≥„ÉóÁ≠â„ÅÆÊó¢Â≠ò„Çπ„Çø„Ç§„É´ */
    #store-list { flex: 1; overflow-y: auto; padding: 0; margin: 0; list-style: none; -webkit-overflow-scrolling: touch;}
    .store-item { padding: 12px 20px; border-bottom: 0.5px solid #c6c6c8; display: flex; justify-content: space-between; align-items: center; background: #fff; position: relative; min-height: 70px; }
    .store-info { display: flex; flex-direction: column; }
    .store-name { font-weight: 600; font-size: 16px; margin-bottom: 4px; }
    .store-dist { font-size: 13px; color: #8E8E93; }
    .btn-checkin { background: #F0F0F5; color: #007AFF; border: none; padding: 6px 18px; border-radius: 16px; font-size: 14px; font-weight: 700; cursor: pointer; transition: all 0.2s; min-width: 70px; }
    .btn-checkin:active { background: #E5E5EA; transform: scale(0.96); }
    .btn-placeholder { width: 70px; }
    .stamp-container { position: absolute; right: 20px; top: 50%; transform: translateY(-50%) rotate(-10deg); display: flex; flex-direction: column; align-items: center; justify-content: center; opacity: 0; pointer-events: none; z-index: 10; }
    .stamp-circle { width: 64px; height: 64px; border: 3px double #C62828; border-radius: 50%; background: rgba(255, 255, 255, 0.85); display: flex; flex-direction: column; justify-content: center; align-items: center; color: #C62828; box-shadow: 0 0 0 1px rgba(255,255,255,0.5); }
    .stamp-row { line-height: 1.2; white-space: nowrap; text-align: center; max-width: 90%; overflow: hidden; text-overflow: ellipsis; }
    .stamp-row.date { font-family: "Courier New", monospace; font-size: 10px; font-weight: bold; border-bottom: 1px solid #C62828; padding-bottom: 2px; margin-bottom: 2px; width: 80%; }
    .stamp-row.name { font-family: "Hiragino Mincho ProN", serif; font-size: 10px; font-weight: 900; padding: 1px 0; }
    .stamp-row.year { font-family: "Courier New", monospace; font-size: 10px; font-weight: bold; border-top: 1px solid #C62828; padding-top: 2px; margin-top: 2px; width: 80%; }
    .stamp-container.show { animation: stamp-press 0.4s cubic-bezier(0.2, 1.5, 0.6, 1) forwards; }
    @keyframes stamp-press { 0% { opacity: 0; transform: translateY(-50%) scale(2.5) rotate(15deg); } 100% { opacity: 1; transform: translateY(-50%) scale(1) rotate(-10deg); } }
  </style>
</head>
<body>
  <div id="map"></div>
  <div id="panel">
    <div id="header">
      <h2>„Åæ„ÅÑ„Å∞„Åô„É©„É™„Éº <span class="area-badge">Êù±‰∫¨Áâà</span></h2>
      <div id="status-text">„Éá„Éº„ÇøË™≠„ÅøËæº„Åø‰∏≠...</div>
    </div>
    <ul id="store-list"></ul>
    
    <div id="menu-btn" onclick="openModal()">‚ùî</div>
  </div>

  <div id="modal-overlay" onclick="closeModal(event)">
    <div id="modal-content" onclick="event.stopPropagation()">
      <div style="padding:20px; text-align:center; color:#666;">Ë™≠„ÅøËæº„Åø‰∏≠...</div>
    </div>
  </div>

  <script>
    let STORES = []; 
    const SEARCH_RADIUS = 3000; 
    const CHECKIN_RADIUS = 50;  
    const MONTH_NAMES = ["JAN", "FEB", "MAR", "APR", "MAY", "JUN", "JUL", "AUG", "SEP", "OCT", "NOV", "DEC"];
    
    // JRÂ§ßÊ£ÆÈßÖ„ÅÆÂ∫ßÊ®ô („Éá„É¢„É¢„Éº„ÉâÁî®)
    const DEMO_LAT = 35.588463;
    const DEMO_LNG = 139.727977;

    let map;
    let visitedData = JSON.parse(localStorage.getItem('visitedStoresV3')) || [];
    let currentStoreList = [];
    let isGeofenceEnabled = false; 
    let isDemoMode = false; // „Éá„É¢„É¢„Éº„Éâ„ÅÆÁä∂ÊÖã

    const storeIcon = L.icon({
      iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-red.png',
      shadowUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/images/marker-shadow.png',
      iconSize: [25, 41], iconAnchor: [12, 41], popupAnchor: [1, -34], shadowSize: [41, 41]
    });

    window.onload = async function() {
      // Ë®≠ÂÆö„ÅÆÂæ©ÂÖÉ
      if(localStorage.getItem('isGeofenceEnabled') === 'true') isGeofenceEnabled = true;
      if(localStorage.getItem('isDemoMode') === 'true') isDemoMode = true;

      // content.html „ÇíË£è„ÅßË™≠„ÅøËæº„Çì„Åß„Åä„Åè
      fetchContent();

      try {
        const response = await fetch('stores.json');
        if (!response.ok) throw new Error("JSON not found");
        STORES = await response.json();
      } catch (e) {
        document.getElementById('status-text').innerText = "„Éá„Éº„ÇøË™≠Ëæº„Ç®„É©„Éº";
        return;
      }

      startApp();
    };

    // content.html „ÇíÂèñÂæó„Åó„Å¶„É¢„Éº„ÉÄ„É´„Å´„Çª„ÉÉ„Éà
    async function fetchContent() {
      try {
        const res = await fetch('content.html');
        const text = await res.text();
        document.getElementById('modal-content').innerHTML = text;
        
        // HTMLÊåøÂÖ•Âæå„Å´„Éà„Ç∞„É´„ÅÆÁä∂ÊÖã„ÇíÂèçÊò†
        const geoToggle = document.getElementById('geo-toggle');
        const demoToggle = document.getElementById('demo-toggle');
        if(geoToggle) geoToggle.checked = isGeofenceEnabled;
        if(demoToggle) demoToggle.checked = isDemoMode;
        
      } catch(e) { console.error("Menu load failed", e); }
    }

    function startApp() {
      document.getElementById('status-text').innerText = "GPSÂèñÂæó‰∏≠...";
      
      // „Éá„É¢„É¢„Éº„Éâ„Å™„ÇâGPS„Çí‰Ωø„Çè„ÅöÂõ∫ÂÆöÂ∫ßÊ®ô„Å∏
      if (isDemoMode) {
        document.getElementById('status-text').innerText = "„Éá„É¢„É¢„Éº„Éâ(JRÂ§ßÊ£ÆÈßÖ)";
        initMap(DEMO_LAT, DEMO_LNG);
        return;
      }

      if (!navigator.geolocation) {
        document.getElementById('status-text').innerText = "GPSÈùûÂØæÂøú";
        return;
      }
      navigator.geolocation.getCurrentPosition(
        (pos) => { initMap(pos.coords.latitude, pos.coords.longitude); },
        (err) => { document.getElementById('status-text').innerText = "GPS„Ç®„É©„Éº"; },
        { enableHighAccuracy: true }
      );
    }

    function initMap(lat, lng) {
      if(map) { map.remove(); } // ÂÜçÊèèÁîªÁî®
      map = L.map('map').setView([lat, lng], 13);
      L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { attribution: '¬© OpenStreetMap' }).addTo(map);
      
      // „Éû„Éº„Ç´„Éº„ÅÆËâ≤„ÇíÂ§â„Åà„ÇãÔºà„Éá„É¢‰∏≠„ÅØËµ§Ëâ≤„Å™„Å©Ôºâ
      L.marker([lat, lng]).addTo(map).bindPopup(isDemoMode ? "„Éá„É¢ÁèæÂú®Âú∞" : "ÁèæÂú®Âú∞").openPopup();
      L.circle([lat, lng], { color: '#007AFF', weight: 1, fillOpacity: 0.05, radius: SEARCH_RADIUS }).addTo(map);
      searchAndListStores(lat, lng);
    }

    function searchAndListStores(currentLat, currentLng) {
      const currentPos = L.latLng(currentLat, currentLng);
      let foundStores = [];

      STORES.forEach(store => {
        if(!store.lat || !store.lng) return;
        const storePos = L.latLng(store.lat, store.lng);
        const dist = currentPos.distanceTo(storePos);
        if (dist <= SEARCH_RADIUS) {
          store.distance = dist;
          foundStores.push(store);
        }
      });

      foundStores.sort((a, b) => a.distance - b.distance);
      currentStoreList = foundStores;
      updateStatusText();

      const listEl = document.getElementById('store-list');
      listEl.innerHTML = "";

      foundStores.forEach((store) => {
        const visitedRecord = visitedData.find(v => v.name === store.name);
        const isVisited = !!visitedRecord;
        
        let stampDate = { line1: "DATE", line3: "YEAR" }; 
        if (visitedRecord && visitedRecord.timestamp) {
          stampDate = formatStampDate(new Date(visitedRecord.timestamp));
        }
        
        const marker = L.marker([store.lat, store.lng], { icon: storeIcon }).addTo(map);
        marker.bindPopup(`<b>${store.name}</b><br>${Math.round(store.distance)}m`);
        
        const li = document.createElement('li');
        li.className = 'store-item';
        
        const shortName = store.name.replace('„Åæ„ÅÑ„Å∞„Åô„Åë„Å£„Å®', '').replace('ÈßÖ', '').substring(0, 6);

        const stampHtml = 
          '<div id="stamp-' + store.name + '" class="stamp-container ' + (isVisited ? 'show' : '') + '">' +
            '<div class="stamp-circle">' +
              '<span class="stamp-row date">' + stampDate.line1 + '</span>' +
              '<span class="stamp-row name">' + shortName + '</span>' +
              '<span class="stamp-row year">' + stampDate.line3 + '</span>' +
            '</div>' +
          '</div>';
        
        const btnHtml = isVisited 
          ? '<div class="btn-placeholder"></div>'
          : '<button id="btn-' + store.name + '" class="btn-checkin" onclick="checkIn(\'' + store.name + '\', ' + store.lat + ', ' + store.lng + ', this)">GET</button>';

        li.innerHTML = 
          '<div class="store-info">' +
            '<span class="store-name">' + store.name + '</span>' +
            '<span class="store-dist">ÁèæÂú®Âú∞„Åã„Çâ ' + Math.round(store.distance) + 'm</span>' +
          '</div>' +
          stampHtml +
          btnHtml;
        
        li.addEventListener('click', (e) => {
          if(e.target.tagName !== 'BUTTON') {
             marker.openPopup(); 
             map.panTo([store.lat, store.lng]);
          }
        });
        listEl.appendChild(li);
      });
      
      if (foundStores.length === 0) {
        document.getElementById('status-text').innerText = "Ëøë„Åè„Å´Â∫óËàó„ÅåË¶ã„Å§„Åã„Çä„Åæ„Åõ„Çì„Åß„Åó„Åü";
      }
    }

    function formatStampDate(d) {
      const month = MONTH_NAMES[d.getMonth()];
      const day = d.getDate();
      const year = d.getFullYear();
      return { line1: month + " " + day, line3: year };
    }

    function updateStatusText() {
      if (currentStoreList.length === 0) return;
      const visitedCount = currentStoreList.filter(s => visitedData.some(v => v.name === s.name)).length;
      document.getElementById('status-text').innerHTML = 
        `ÂçäÂæÑ3km‰ª•ÂÜÖ„Å´ <span class="highlight">${currentStoreList.length}</span> ‰ª∂ („ÅÜ„Å° <span class="highlight">${visitedCount}</span> ‰ª∂ Âà∂Ë¶á)`;
    }

    window.checkIn = function(storeName, targetLat, targetLng, btn) {
      if (visitedData.some(v => v.name === storeName)) return;

      // „Éá„É¢„É¢„Éº„Éâ‰∏≠„ÅØÁÑ°Êù°‰ª∂„ÅßOK„Å´„Åô„ÇãÔºàÊíÆÂΩ±Áî®Ôºâ
      if (!isGeofenceEnabled || isDemoMode) {
        successCheckIn(storeName, btn);
        return;
      }

      const originalText = btn.innerText;
      btn.innerText = "Âà§ÂÆö‰∏≠...";
      
      navigator.geolocation.getCurrentPosition(
        (pos) => {
          const currentPos = L.latLng(pos.coords.latitude, pos.coords.longitude);
          const targetPos = L.latLng(targetLat, targetLng);
          const dist = currentPos.distanceTo(targetPos);

          if (dist <= CHECKIN_RADIUS) {
            successCheckIn(storeName, btn);
          } else {
            alert(`üìç „Åæ„Å†ÈÅ†„ÅÑ„Åß„ÅôÔºÅ\nÁèæÂú®Âú∞„Åã„Çâ: ${Math.round(dist)}m\n(ÊÆã„Çä ${Math.round(dist - CHECKIN_RADIUS)}m)`);
            btn.innerText = originalText;
          }
        },
        (err) => {
          alert("‰ΩçÁΩÆÊÉÖÂ†±„ÅåÂèñÂæó„Åß„Åç„Åæ„Åõ„Çì");
          btn.innerText = originalText;
        },
        { enableHighAccuracy: true }
      );
    };

    function successCheckIn(storeName, btn) {
      const now = new Date();
      visitedData.push({ name: storeName, timestamp: now.getTime() });
      localStorage.setItem('visitedStoresV3', JSON.stringify(visitedData));
      
      const stampData = formatStampDate(now);
      const stampContainer = document.getElementById('stamp-' + storeName);
      if(stampContainer) {
        const dateEl = stampContainer.querySelector('.stamp-row.date');
        const yearEl = stampContainer.querySelector('.stamp-row.year');
        if(dateEl) dateEl.innerText = stampData.line1;
        if(yearEl) yearEl.innerText = stampData.line3;
        stampContainer.classList.add('show');
      }

      btn.style.opacity = '0';
      setTimeout(() => { btn.style.visibility = 'hidden'; }, 300);
      updateStatusText();
      if (window.navigator.vibrate) window.navigator.vibrate(50);
    }

    // --- „É°„Éã„É•„Éº„ÉªË®≠ÂÆöÊìç‰Ωú ---
    window.openModal = function() {
      document.getElementById('modal-overlay').classList.add('show');
    };
    window.closeModal = function(e) {
      // ËÉåÊôØ„ÇØ„É™„ÉÉ„ÇØ„Åæ„Åü„ÅØÈñâ„Åò„Çã„Éú„Çø„É≥„ÅßÈñâ„Åò„Çã
      if (!e || e.target.id === 'modal-overlay' || e.target.classList.contains('close-btn')) {
        document.getElementById('modal-overlay').classList.remove('show');
      }
    };
    
    window.toggleGeofence = function() {
      const toggle = document.getElementById('geo-toggle');
      isGeofenceEnabled = toggle.checked;
      localStorage.setItem('isGeofenceEnabled', isGeofenceEnabled);
    };

    window.toggleDemoMode = function() {
      const toggle = document.getElementById('demo-toggle');
      isDemoMode = toggle.checked;
      localStorage.setItem('isDemoMode', isDemoMode);
      
      // „Éá„É¢„É¢„Éº„ÉâÂàáÊõøÊôÇ„ÅØ„É™„É≠„Éº„Éâ„Åó„Å¶‰ΩçÁΩÆÊÉÖÂ†±„ÇíÂÜçÂèñÂæó
      location.reload(); 
    };

    window.resetData = function() {
      if(confirm("Êú¨ÂΩì„Å´„Çπ„Çø„É≥„Éó„ÇíÂÖ®Ê∂àÂéª„Åó„Å¶„ÅÑ„ÅÑ„Åß„Åô„ÅãÔºü")) {
        visitedData = [];
        localStorage.removeItem('visitedStoresV3');
        location.reload();
      }
    };
  </script>
</body>
</html>